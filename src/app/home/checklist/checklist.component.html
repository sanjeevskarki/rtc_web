<div id="modalTarget" #targetModal>
    <mat-table #table [dataSource]="viewReleaseChecklist" class="tableStyle">
        <ng-container matColumnDef="vector">
            <mat-header-cell *matHeaderCellDef>Vector</mat-header-cell>
            <mat-cell *matCellDef="let row">{{row.vector}}</mat-cell>
        </ng-container>
        <ng-container matColumnDef="details">
            <mat-header-cell *matHeaderCellDef>Details</mat-header-cell>
            <mat-cell *matCellDef="let row">{{row.details}}</mat-cell>
        </ng-container>
        <ng-container matColumnDef="owner">
            <mat-header-cell *matHeaderCellDef>Owner</mat-header-cell>
            <mat-cell *matCellDef="let row">
                <div>
                    <div>{{row.owner}}</div>
                    <div style="font-size: 11px">{{row.owner_email}}</div>
                </div>
                <div>
                    <div>
                        <button mat-icon-button matTooltip="Add / Edit Owner" color="primary"
                            (click)="addOwner(addOwnerDialog,row.id,row.owner,row.owner_email)">
                            <mat-icon>person_outline</mat-icon>
                        </button>
                    </div>
                </div>
            </mat-cell>
        </ng-container>
        <ng-container matColumnDef="detailedStatus">
            <mat-header-cell *matHeaderCellDef>Detailed Status</mat-header-cell>
            <mat-cell *matCellDef="let row">
                <div *ngIf="row.detailedStatus">
                    <div *ngFor="let f of row.detailedStatus; let i = index">
                        <div [innerHTML]="f"></div>
                    </div>
                </div>
                <div *ngIf="row.bdbaStatus && row.detailedStatus">
                    <button mat-icon-button matTooltip="View Report" color="accent" (click)="openBdbaReport()">
                        <mat-icon>file_copy</mat-icon>
                    </button>
                </div>
            </mat-cell>
        </ng-container>

        <ng-container matColumnDef="status">
            <mat-header-cell *matHeaderCellDef>Status</mat-header-cell>

            <mat-cell *matCellDef="let row">
                <div *ngIf="row.status === 'Done'" class="statustemp e-donecolor">
                    <mat-select (selectionChange)="changeStatus(row.id,$event.value)" matTooltip="Done"
                        [(value)]="row.status">
                        <mat-option *ngFor="let status of taskStatus" [value]="status.value">
                            {{status.viewValue}}
                        </mat-option>
                    </mat-select>
                </div>
                <div *ngIf="row.status === 'WIP'" class="statustemp e-wipcolor">
                    <mat-select (selectionChange)="changeStatus(row.id,$event.value)" matTooltip="WIP"
                        [(value)]="row.status">
                        <mat-option *ngFor="let status of taskStatus" [value]="status.value">
                            {{status.viewValue}}
                        </mat-option>
                    </mat-select>
                </div>
                <div *ngIf="row.status === 'Open'" class="statustemp e-opencolor">
                    <mat-select (selectionChange)="changeStatus(row.id,$event.value)" matTooltip="Open"
                        [(value)]="row.status">
                        <mat-option *ngFor="let status of taskStatus" [value]="status.value">
                            {{status.viewValue}}
                        </mat-option>
                    </mat-select>
                </div>
                <div *ngIf="row.status === 'N/A'" class="statustemp e-nacolor">
                    <mat-select (selectionChange)="changeStatus(row.id,$event.value)" matTooltip="N/A"
                        [(value)]="row.status">
                        <mat-option *ngFor="let status of taskStatus" [value]="status.value">
                            {{status.viewValue}}
                        </mat-option>
                    </mat-select>
                </div>
                <div *ngIf="row.status === 'Pending Exception'" class="statustemp e-opencolor">
                    <mat-select (selectionChange)="changeStatus(row.id,$event.value)" matTooltip="Pending Exception"
                        [(value)]="row.status">
                        <mat-option *ngFor="let status of taskStatus" [value]="status.value">
                            {{status.viewValue}}
                        </mat-option>
                    </mat-select>
                </div>
                <div *ngIf="row.status === 'Formal Exception Approved'" class="statustemp e-donecolor">
                    <mat-select (selectionChange)="changeStatus(row.id,$event.value)"
                        matTooltip="Formal Exception Approved" [(value)]="row.status">
                        <mat-option *ngFor="let status of taskStatus" [value]="status.value">
                            {{status.viewValue}}
                        </mat-option>
                    </mat-select>
                </div>
                <div *ngIf="row.status === 'Deviation Approved'" class="statustemp e-donecolor">
                    <mat-select (selectionChange)="changeStatus(row.id,$event.value)" matTooltip="Deviation Approved"
                        [(value)]="row.status">
                        <mat-option *ngFor="let status of taskStatus" [value]="status.value">
                            {{status.viewValue}}
                        </mat-option>
                    </mat-select>
                </div>
            </mat-cell>
        </ng-container>
        <ng-container matColumnDef="releaseCriteria">
            <mat-header-cell *matHeaderCellDef>Release Criteria</mat-header-cell>
            <mat-cell *matCellDef="let row">{{row.releaseCriteria}}</mat-cell>
        </ng-container>
        <ng-container matColumnDef="evidence">
            <mat-header-cell *matHeaderCellDef>Evidence</mat-header-cell>
            <mat-cell *matCellDef="let row">
                <div *ngIf="row.evidences.length > 0 ; else noEvidence">
                    <button mat-flat-button matTooltip="View / Add Evidence" color="primary" style="line-height: 20px !important;
                    font-size: 12px !important" (click)="onEvidenceClicked(evidenceDialog,row.id)">
                        <mat-icon>add</mat-icon>View / Add
                    </button>
                </div>
                <ng-template #noEvidence>
                    <div>
                        <div class="firstline cell-line">No Evidence Found</div>
                        <div class="secondline cell-line">
                            <button mat-stroked-button color="primary"
                                (click)="onEvidenceClicked(evidenceDialog,row.id)">
                                <mat-icon>add</mat-icon>Add Evidence
                            </button>
                        </div>
                    </div>
                </ng-template>
            </mat-cell>
        </ng-container>
        <ng-container matColumnDef="comments">
            <mat-header-cell *matHeaderCellDef>Comments</mat-header-cell>
            <mat-cell *matCellDef="let row">
                <div style="width: 30rem;" *ngIf="row.comments.length > 0; else noComments"
                    class="firstline cell-line comment-div">
                    <div class="firstline cell-line">
                        <div>{{row.comments[0].comments}}</div>
                        <div (click)="openFile(row.comments[0].content,'attachments')" style="cursor: pointer;font-size: 11px;
                        color: blue;">
                            <u>{{ row.comments[0].content }}</u>
                        </div>
                        <div style="font-size: 11px;"> {{row.comments[0].date | date:'medium'}} </div>
                    </div>
                    <div class="secondline cell-line">
                        <button mat-flat-button matTooltip="View / Add Comments" color="primary" style="line-height: 20px !important;
                            font-size: 12px !important" (click)="onCommentClicked(commentDialog,row.id)">
                            <mat-icon>add</mat-icon>View / Add
                        </button>
                    </div>
                </div>
                <ng-template #noComments>
                    <div>
                        <div class="firstline cell-line">No Comment Found</div>
                        <div class="secondline cell-line">
                            <button mat-stroked-button color="primary"
                                (click)="onCommentClicked(commentDialog,row.id)">
                                <mat-icon>add</mat-icon>Add Comments
                            </button>
                        </div>
                    </div>
                </ng-template>

            </mat-cell>
        </ng-container>
        <mat-header-row *matHeaderRowDef="displayedColumns;sticky: true" [style.background-color]="color">
        </mat-header-row>

        <mat-row *matRowDef="let row; columns: displayedColumns;" [style.background-color]="getClass(row)">

        </mat-row>

        <!-- <ng-container matColumnDef="groupHeader">
            <mat-cell colspan="999" *matCellDef="let group">
                <mat-icon *ngIf="group.expanded">expand_less</mat-icon>
                <mat-icon *ngIf="!group.expanded">expand_more</mat-icon>
                <strong>{{groupByColumns[group.level-1]}} = {{group[groupByColumns[group.level-1]]}}
                    ({{group.totalCounts}})</strong>
            </mat-cell>
        </ng-container> -->
    </mat-table>
    <div *ngIf="isLoading" style="display: flex; justify-content: center; align-items: center; background: white;">
        <mat-progress-spinner strokeWidth="3" [diameter]="50" color="primary" mode="indeterminate">
        </mat-progress-spinner>
    </div>

</div>
<!--
    Dialog shows the comments list
-->
<ng-template #commentDialog>
    <h1 mat-dialog-title>{{commentsHeader}}</h1> 
    <mat-list>
        <mat-list-item *ngFor="let comment of displayComments">
            <div style="display: flex;">
            <button mat-icon-button color="primary" matTooltip="Edit Comment"
                    (click)="editSelectedComment(addCommentDialog,comment)">
                    <mat-icon>edit</mat-icon>
            </button>
            <div style="width:100%">
                <div style="font-size: 12px;" class="detailsAnswer"><b>{{comment.date | dateTimePipe}}</b>
                </div>
                <div class="posting">{{comment.comments}}</div>
                <div class="posting" (click)="openFile(comment.content,'attachments')" style="cursor: pointer;
                font-size: 11px;
                color: blue;">
                    <u>{{ comment.content }}</u>
                </div><br>
            </div>
        </div>
        </mat-list-item>
        
    </mat-list>
  
    <br>
    <div class="no-results" [style.display]="displayComments.length == 0 ? '' : 'none'">
        No Comments Found, Click <b> &nbsp;Add Another Comment&nbsp; </b> for adding New Comment
    </div>
    <div class="form-group" style="float: right;padding-bottom: 5px;">
        <button mat-flat-button color="primary" style="float: right;margin: 8px 8px 0;"
            (click)="closeCommentDialog()">Close</button>
        <button mat-flat-button color="primary" style="float: right;margin: 8px 0 0;"
            (click)="openCommentDialog(addCommentDialog)">Add Another Comment</button>

    </div>
</ng-template>
<!--
    Dialog for adding a new comment
-->
<ng-template #addCommentDialog>
    <h1 mat-dialog-title>{{commentFormHeader}}</h1>
    <form class="example-form" [formGroup]="addCommentForm">
        <mat-form-field appearance="outline" style="display: inline;">
            <mat-label>Comments</mat-label>
            <textarea matInput formControlName="comment"></textarea>
            <mat-error
                *ngIf="addCommentForm.controls.comment.hasError('required') && addCommentForm.controls.comment.touched">
                Comment is required
            </mat-error>
        </mat-form-field>
        <div style="height: 0.5rem;"></div>
        <div class="form-group">
            <div style="display: flex;">
                <div>
                    <button mat-flat-button (click)="openCommentInput()" color="primary" style="margin-bottom: 10px;">Select File to
                    Upload</button>
                    <div style="margin-left: 1rem;
                    font-size: smaller;
                    margin-top: -10px;">
                    <mat-hint >MaxFileSize: 10mb</mat-hint>
                    <!-- <mat-error *ngIf="!validFileSize">
                        File Size Exceed the (10mb) limit
                    </mat-error> -->
                    </div>
                </div>
                <div style="font-size: smaller;margin-left: 2px;">
                    <input id="commentFileInput" hidden type="file" (change)="selectCommentFile($event)" formControlName="upload"
                    name="upload" accept=".txt,.csv,.xlsv,.docx,.pdf,.msg,.ppt,.doc,.rtf,.pptx,.xls">
                    <mat-label *ngIf="selectedCommentFile">{{selectedFilename}}</mat-label>
                </div>
            </div>
            <div style="height: 1rem;"></div>
            <div *ngIf="uploading">Uploading File to Server..
                <mat-progress-bar mode="indeterminate"></mat-progress-bar>
                <br>
            </div>
            <!-- <button mat-flat-button (click)="openCommentInput()" color="primary">Select File to Upload</button>
            <div style="margin-left: 1rem;
            font-size: smaller;">
            <mat-hint >MaxFileSize: 10mb</mat-hint>
            </div>
            
            <input id="commentFileInput" hidden type="file" (change)="selectCommentFile($event)"
                formControlName="upload" name="upload"
                accept=".txt,.csv,.xlsv,.docx,.pdf,.msg,.ppt,.doc,.rtf,.pptx,.xls">&nbsp;&nbsp;
            <mat-label *ngIf="selectedCommentFile">{{selectedCommentFile.name}}</mat-label>
            <div *ngIf="uploading">Uploading File to Server..
                <mat-progress-bar mode="indeterminate"></mat-progress-bar>
            </div> -->
        </div>
        <br>
        <button mat-flat-button color="primary" style="float: right;margin: 8px 0 0;"
            (click)="closeAddCommentDialog()">Close</button>
        <button mat-flat-button color="primary" style="float: right;margin: 8px 8px 0;"
            (click)="saveComment()" [disabled]="!addCommentForm.valid">Save</button>
    </form>
</ng-template>
<!--
    Dialog shows the evidence list
-->
<ng-template #evidenceDialog>
    <h1 mat-dialog-title>{{evidenceHeader}}</h1>
    <mat-table #evidencetable [dataSource]="displayEvidences">
        <ng-container matColumnDef="evidenceActions">
            <mat-header-cell *matHeaderCellDef>
            </mat-header-cell>
            <mat-cell *matCellDef="let row; let i=index;">
                <button mat-icon-button color="primary" matTooltip="Edit Evidence"
                    (click)="editSelectedEvidence(row)">
                    <mat-icon aria-label="Delete">edit</mat-icon>
                </button>
            </mat-cell>
        </ng-container>
        <ng-container matColumnDef="seq">
            <mat-header-cell *matHeaderCellDef>#</mat-header-cell>
            <mat-cell *matCellDef="let row">{{row.seq}}</mat-cell>
        </ng-container>
        <ng-container matColumnDef="actions">
            <mat-header-cell *matHeaderCellDef></mat-header-cell>
            <mat-cell *matCellDef="let row">
                <div *ngIf="row.type === 'file'">
                    <button mat-icon-button matTooltip="View File" color="primary"
                        (click)="openFile(row.evidence,'evidences')">
                        <mat-icon>file_copy</mat-icon>
                    </button>
                </div>
            </mat-cell>
        </ng-container>

        <ng-container matColumnDef="title">
            <mat-header-cell *matHeaderCellDef>Title</mat-header-cell>
            <mat-cell *matCellDef="let row">{{row.title}}</mat-cell>
        </ng-container>

        <ng-container matColumnDef="evidenceChild">
            <mat-header-cell *matHeaderCellDef>Evidence</mat-header-cell>
            <mat-cell *matCellDef="let row">{{row.evidence}}</mat-cell>
        </ng-container>

        <ng-container matColumnDef="evidenceDate">
            <mat-header-cell *matHeaderCellDef>Date</mat-header-cell>
            <mat-cell *matCellDef="let row">{{row.date | dateTimePipe}}</mat-cell>
        </ng-container>

        <ng-container matColumnDef="comments">
            <mat-header-cell *matHeaderCellDef>Comments</mat-header-cell>
            <mat-cell *matCellDef="let row"> {{row.comments}}</mat-cell>
        </ng-container>

        <mat-header-row *matHeaderRowDef="evidenceDisplayedColumns;sticky: true" [style.background-color]="color">
        </mat-header-row>
        <mat-row *matRowDef="let row; columns: evidenceDisplayedColumns;"></mat-row>
    </mat-table>
    <div class="no-results" [style.display]="displayEvidences.length == 0 ? '' : 'none'">
        No Evidence Found, Click <b> &nbsp;Add Evidence&nbsp; </b> for adding New Evidence
    </div>

    <button mat-flat-button color="primary" style="float: right;margin: 8px 0 0;"
        (click)="closeEvidenceListDialog()">
        Close
    </button>
    <button mat-flat-button color="primary" style="float: right;margin: 8px 8px 0;"
        (click)="addEvidence()">
        Add Evidence
    </button>

</ng-template>

<!--
    Add a new evidence
-->
<app-evidenceadd *ngIf="evidenceLoaded"></app-evidenceadd>


<!--
    Dialog for adding a new Owner
-->
<ng-template #addOwnerDialog>
    <h1 mat-dialog-title>Add Owner</h1>
    <form class="example-form" [formGroup]="addOwnerForm">
        <mat-form-field appearance="outline" style="display: inline;">
            <mat-label>Name</mat-label>
            <input type="text" matInput formControlName="name">
            <mat-error *ngIf="addOwnerForm.controls.name.hasError('required') && addOwnerForm.controls.name.touched">
                Name is required
            </mat-error>
        </mat-form-field>
        <mat-form-field appearance="outline" style="display: inline;">
            <mat-label>Email</mat-label>
            <input type="text" matInput formControlName="email">
            <mat-error *ngIf="addOwnerForm.controls.email.hasError('required') && addOwnerForm.controls.email.touched">
                Email is required
            </mat-error>
            <mat-error *ngIf="addOwnerForm.controls.email.hasError('email')">
                Please enter a valid email address
            </mat-error>
        </mat-form-field>
        <br>
        <button mat-flat-button color="primary" style="float: right;margin: 8px 0 0;"
            (click)="closeAddOwnerDialog()">Close</button>
        <button mat-flat-button color="primary" style="float: right;margin: 8px 8px 0;"
            (click)="saveOwner()" [disabled]="!addOwnerForm.valid">Add</button>
    </form>
</ng-template>
